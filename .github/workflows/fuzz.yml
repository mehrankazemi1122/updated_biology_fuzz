name: Parallel FFUF (Custom Wordlist)

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'Target URL (e.g., https://example.com/FUZZ)'
        required: true
        default: 'https://example.com/FUZZ'

jobs:
  scan:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # 10 Parallel chunks. 
        id: ['00', '01', '02', '03', '04', '05', '06', '07', '08', '09']

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 1. Install Tools (FFUF + Crunch)
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y crunch
          
          # Install FFUF
          go install github.com/ffuf/ffuf/v2@latest

      # 2. Generate Your Custom Wordlist
      - name: Generate Custom Wordlist
        run: |
          echo "Starting wordlist generation..."
          
          # --- YOUR SCRIPT START ---
          curl -s https://wordlists-cdn.assetnote.io/data/manual/wordlist_with_underscores.txt > wlist2.txt
          crunch 1 3 abcdefghijklmnopqrstuvwxyz1234567890_-. > 1to3chars.txt
          curl -s https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/directory-list-lowercase-2.3-big.txt > wlist1.txt
          curl -s https://wordlists-cdn.assetnote.io/data/manual/jsp.txt > jsp.txt
          curl -s https://wordlists-cdn.assetnote.io/data/automated/httparchive_directories_1m_2024_05_28.txt > all_dirs.txt
          curl -s https://raw.githubusercontent.com/mehrankazemi1122/biology_Fuzz/main/port_numbers.txt > port_numbers.txt
          curl -s https://raw.githubusercontent.com/PortSwigger/param-miner/master/resources/words | sort -u > words.txt
          
          # Clean slashes
          sed -i 's/^\///' all_dirs.txt
          sed -i 's/^\///' wlist1.txt
          
          # Merge everything into full.txt
          cat all_dirs.txt wlist1.txt wlist2.txt 1to3chars.txt words.txt | sort -u > full.txt
          # --- YOUR SCRIPT END ---

          echo "Wordlist generated. Total lines:"
          wc -l full.txt

      # 3. Split the generated 'full.txt'
      - name: Split Wordlist
        run: |
          # Split full.txt into 10 parts
          split -d -n l/10 full.txt chunk_

      # 4. Run FFUF
      - name: Run FFUF (Chunk ${{ matrix.id }})
        run: |
          CURRENT_CHUNK="chunk_${{ matrix.id }}"
          echo "Scanning with $CURRENT_CHUNK..."
          
          # Run FFUF
          ffuf -u "${{ inputs.target_url }}" -w $CURRENT_CHUNK -o result_${{ matrix.id }}.json -of json -mc all -sa -s

      # 5. Upload Partial Results
      - name: Upload Chunk Artifact
        uses: actions/upload-artifact@v4
        with:
          name: chunk-results-${{ matrix.id }}
          path: result_${{ matrix.id }}.json

  # MERGE JOB (Same as before)
  merge:
    needs: scan
    runs-on: ubuntu-latest
    steps:
      - name: Download All Results
        uses: actions/download-artifact@v4
        with:
          pattern: chunk-results-*
          merge-multiple: true

      - name: Merge JSON Reports
        run: |
          python3 -c "
          import json, glob
          all_findings = []
          for f in glob.glob('result_*.json'):
              try:
                  data = json.load(open(f))
                  if 'results' in data:
                      all_findings.extend(data['results'])
              except: pass
          final_output = {'ffuf_merged_results': all_findings}
          print(json.dumps(final_output, indent=2))
          " > final_report.json

      - name: Upload Final Report
        uses: actions/upload-artifact@v4
        with:
          name: Complete-Scan-Report
          path: final_report.json
